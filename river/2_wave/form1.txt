Option Explicit
Dim 音频输入 As New clsWaveIn
Dim 缓冲区() As Byte, 缓冲区2() As Integer
Dim 音量倍数 As Single

Private Type POINTAPI
    X As Long
    Y As Long
End Type



Private Sub 声卡选择_Click()
    Dim 输入设备格式 As Long, i As Long, l As Long
    If (声卡选择.ListIndex < 0) Then Exit Sub
    开始
End Sub




Private Sub Timer1_Timer()
    Dim 缓冲区指针 As Long, 缓冲区长度 As Long, i As Long, ii As Long
    If (音频输入.BytesPerChannel = 2) Then
        缓冲区指针 = VarPtr(缓冲区2(0))
    Else
        缓冲区指针 = VarPtr(缓冲区(0))
    End If
    Do
        If (音频输入.ReadRecording(缓冲区指针, 1) = 0) Then Exit Do


        If 音频输入.BytesPerChannel <> 2 Then
            For i = 0 To 音频输入.BufferSize - 1
                缓冲区2(i) = (缓冲区(i) - &H80&) * &H100&
            Next i
        End If
        If 音量倍数 <> 1! Then
            For i = 0 To (音频输入.SamplesPerBuffer * 音频输入.Channels) - 1
                ii = 缓冲区2(i) * 音量倍数
                If ii > &H7FFF& Then ii = &H7FFF&
                If ii < &HFFFF8000 Then ii = &HFFFF8000
                缓冲区2(i) = ii
            Next i
        End If


'        Call 数据处理.TestFeed(VarPtr(缓冲区2(0)), ((UBound(缓冲区2) + 1) * 2))
    Loop
    Call 画波形
End Sub









Private Sub 开始()
    Dim i As Long, 频率 As Long



    频率 = 44000
    If Not 音频输入.Create(声卡选择.ListIndex, 频率, 2, 2, 频率 / 25, 16) Then
        Exit Sub '创建失败
    End If


    Call 音频输入.StartRecording '开始录音?



    Timer1.Enabled = True


    Call 数据处理.TestStart

End Sub





Private Sub 画波形()
    Dim m As Long, w As Long, h As Long, l() As POINTAPI, i As Long, ii As Long, hbr As Long, s As String
    m = 音频输入.SamplesPerBuffer
    ReDim l(m - 1) As POINTAPI
    BX.Cls
    w = BX.Width
    h = BX.Height
    For i = 0 To m - 1
        l(i).X = (i * w) \ m
        l(i).Y = (0.5! - (缓冲区2(i) / 65535!)) * h
    Next i
    Call Polyline(BX.hDC, l(0), m - 1)
End Sub





Private Sub Form_Load()
Dim i As Long
音量倍数 = 1
声卡选择.Clear
音频输入.EnumerateWaveInDevice

For i = 0 To 音频输入.WaveInDeviceCount - 1
        Call 声卡选择.AddItem(音频输入.WaveInDeviceName(i))
        If (i = (音频输入.WaveInDeviceCount - 1)) Then 声卡选择.ListIndex = 0
    Next i
End Sub

Private Sub 输出声卡选择_Click()
    音频输入.Destroy
    音频输出.Destroy
    数据处理.Destroy
    Timer1.Enabled = False
    开始
End Sub